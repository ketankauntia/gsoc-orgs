# Trending Feature Architecture

## Overview

The trending feature provides time-based snapshots of entity popularity (organizations, projects, tech-stack, topics) across multiple time ranges (daily, weekly, monthly, yearly). The system uses file-based snapshots generated by automated cron jobs, ensuring zero runtime computation overhead and full historical archive support.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Route Structure](#route-structure)
3. [Data Storage](#data-storage)
4. [Data Generation](#data-generation)
5. [Archive System](#archive-system)
6. [UI Components](#ui-components)
7. [Caching & Performance](#caching--performance)
8. [GitHub Actions Workflow](#github-actions-workflow)
9. [File Structure](#file-structure)
10. [Type Definitions](#type-definitions)
11. [Future Considerations](#future-considerations)

---

## Architecture Overview

### Design Principles

1. **Resource-First Routing**: `/trending/:entity` where entity is the primary resource
2. **Time as Query Parameter**: Time range selected via `?range=daily|weekly|monthly|yearly`
3. **File-Based Snapshots**: Static JSON files, no runtime database queries
4. **Zero Runtime Cost**: All computation happens during generation, not page load
5. **Historical Archive**: Year/month-segmented files for complete history
6. **Deterministic Ranking**: Stable sorting with tie-breakers to prevent noisy commits

### Key Components

- **Generation Script**: `scripts/generate-trending-data.ts` - Calculates trends and writes JSON files
- **Type Definitions**: `lib/trending-types.ts` - TypeScript types and loader functions
- **Page Route**: `app/trending/[entity]/page.tsx` - Server component for route handling
- **Client Component**: `app/trending/[entity]/trending-page-client.tsx` - Interactive UI
- **GitHub Actions**: `.github/workflows/generate-trending.yml` - Automated daily generation

---

## Route Structure

### Base Route Pattern

```
/trending/:entity
```

Where `:entity` can be:
- `organizations`
- `projects`
- `tech-stack`
- `topics`

### Query Parameters

- `range` (optional): `daily` | `weekly` | `monthly` | `yearly` (defaults to `monthly`)
- `year` (optional): Year for archive view (e.g., `2025`)
- `month` (optional): Month for archive view (1-12, only for monthly/weekly/daily ranges)

### Example Routes

```
/trending/organizations                          → Current monthly snapshot
/trending/organizations?range=daily              → Current daily snapshot
/trending/organizations?range=yearly&year=2024  → 2024 yearly archive
/trending/organizations?range=monthly&year=2025&month=1  → January 2025 archive
```

### Route Semantics

**Why this structure?**
- Matches user thinking: "What are trending organizations this month?"
- Prevents route explosion (no `/trending/organizations/monthly/2025/01` paths)
- SEO-friendly: One canonical page per entity
- Query params handle state, not new page types

---

## Data Storage

### File Structure

```
new-api-details/trending/
├── organizations/
│   ├── daily.json              # Latest daily snapshot
│   ├── weekly.json             # Latest weekly snapshot
│   ├── monthly.json            # Latest monthly snapshot
│   ├── yearly.json             # Latest yearly snapshot
│   ├── daily/
│   │   ├── 2025-01-26.json    # Archive: Jan 26, 2025
│   │   └── 2025-01-27.json    # Archive: Jan 27, 2025
│   ├── weekly/
│   │   └── 2025-W04.json      # Archive: ISO week 4 of 2025 (Monday start)
│   ├── monthly/
│   │   ├── 2025-01.json       # Archive: January 2025
│   │   └── 2025-02.json       # Archive: February 2025
│   └── yearly/
│       ├── 2024.json          # Archive: Year 2024
│       └── 2025.json          # Archive: Year 2025
├── projects/
│   └── [same structure]
├── tech-stack/
│   └── [same structure]
└── topics/
    └── [same structure]
```

**Note on Weekly Archive Naming:**
- Weekly snapshots use ISO-8601 week numbering format: `YYYY-Www.json`
- ISO weeks start on Monday
- Week 1 is the first week containing a Thursday
- Example: `2025-W04.json` = ISO week 4 of 2025

### Snapshot Format

```typescript
interface TrendingSnapshot {
  entity: 'organizations' | 'projects' | 'tech-stack' | 'topics';
  range: 'daily' | 'weekly' | 'monthly' | 'yearly';
  snapshot_at: string;          // ISO timestamp - generation time (single source of truth)
  items: TrendingItem[];
  meta: {
    version: number;
    total_items: number;
  };
}

interface TrendingItem {
  id: string;
  slug: string;
  name: string;
  change: number;              // Absolute change (e.g., +15)
  change_percent: number;      // Percentage change (e.g., 12.5)
  current_value: number;       // Current period count
  previous_value: number;       // Previous period count
  rank: number;                // 1-based ranking
  metadata?: Record<string, unknown>;  // Entity-specific data
}
```

### Storage Strategy

1. **Latest Snapshots**: `{entity}/{range}.json` - Always points to most recent data
2. **Archive Files**: 
   - Daily: `{entity}/daily/{year}-{month}-{day}.json`
   - Weekly: `{entity}/weekly/{year}-W{week}.json` (ISO-8601 format)
   - Monthly: `{entity}/monthly/{year}-{month}.json`
   - Yearly: `{entity}/yearly/{year}.json`
3. **Atomic Writes**: Files written to temp location, then renamed to prevent corruption
4. **Immutable Archives**: Once written, archive files are never modified

### Retention Policy

All archive files are retained indefinitely:
- **Daily**: Retained indefinitely (enables long-term trend analysis)
- **Weekly**: Retained indefinitely (ISO week format ensures consistency)
- **Monthly**: Retained indefinitely (standard time period)
- **Yearly**: Retained indefinitely (yearly summaries)

**Rationale**: Historical trending data is valuable for analytics, comparisons, and understanding long-term patterns. Storage cost is minimal compared to the value of complete historical records.

---

## Data Generation

### Generation Script

**Location**: `scripts/generate-trending-data.ts`

**Execution**: 
- Manual: `npm run generate:trending`
- Automated: Daily via GitHub Actions at 00:00 UTC

### Generation Process

1. **For each entity × range combination:**
   - Fetch current period data from database
   - Load previous snapshot (from latest.json or archive)
   - Calculate change and change_percent
   - Rank items by current_value (descending)
   - Apply tie-breaker (by id/slug) for stable ranking

2. **Write Files:**
   - Write archive file: `{range}/{year}-{month}.json` or `yearly/{year}.json`
   - Write latest file: `{range}.json` (overwrites previous)

3. **Entity-Specific Logic:**

   **Organizations:**
   - Count: `total_projects` field
   - Metadata: Includes logo URLs, category, total_projects

   **Projects:**
   - Count: Distinct project occurrences
   - Metadata: Includes org_slug, org_name, year

   **Tech Stack:**
   - Count: Organization count using the technology
   - Metadata: Includes org_count, project_count

   **Topics:**
   - Count: Organization count with the topic
   - Metadata: Includes organization_count, project_count

### Change Calculation

```typescript
function calculateChange(current: number, previous: number) {
  const change = current - previous;
  const change_percent = previous > 0 
    ? (change / previous) * 100 
    : (current > 0 ? 100 : 0);
  return { change, change_percent };
}
```

### Stable Ranking

To prevent noisy reordering when counts are equal:

```typescript
items.sort((a, b) => {
  // Primary: by current_value descending
  if (b.current_value !== a.current_value) {
    return b.current_value - a.current_value;
  }
  // Tie-breaker: by id/slug (deterministic)
  return a.id.localeCompare(b.id);
});
```

### Empty Data Handling

- If current window has zero data: still write snapshot with empty items array
- Never delete previous files
- Preserves file structure even during data gaps

---

## Archive System

### Archive Discovery

**Function**: `getAvailableArchiveData(entity)` in `lib/trending-types.ts`

**Process:**
1. Scans `{entity}/{range}/` directories for monthly/weekly/daily archives
2. Scans `{entity}/yearly/` directory for yearly archives
3. Parses filenames:
   - Daily: `YYYY-MM-DD.json`
   - Weekly: `YYYY-Www.json` (ISO-8601 format)
   - Monthly: `YYYY-MM.json`
   - Yearly: `YYYY.json`
4. Returns structured data: `ArchiveEntry[]`

**Performance Note**: 
- Current implementation scans directories at page load (acceptable for < 10k files)
- If archive file count exceeds 10,000, consider precomputing an index file
- Index could be generated alongside snapshots and loaded once per entity

```typescript
interface ArchiveEntry {
  year: number;
  months?: number[];        // Available months (1-12)
  hasYearly?: boolean;      // Whether yearly data exists
}
```

### Archive Navigation

**Past Archive Sidebar:**
- Fixed left sidebar (240px width)
- Shows years with yearly data as clickable links
- Shows months under each year (jan, feb, mar, etc.)
- Only displays entries where data exists
- Teal highlighting for active archive view

**Archive Links:**
- Year: `/trending/{entity}?range=yearly&year={year}`
- Month: `/trending/{entity}?range={currentRange}&year={year}&month={month}`

### Archive Loading

**Function**: `loadTrendingSnapshot(entity, range, year?, month?)`

**Resolution Logic:**
1. If `year` and `month` provided → Load `{range}/{year}-{month}.json`
2. If `year` provided (yearly) → Load `yearly/{year}.json`
3. Otherwise → Load `{range}.json` (latest snapshot)

**Implementation:**
- Uses `fs.readFileSync` (server-side only)
- Returns `null` if file doesn't exist
- Graceful fallback to latest snapshot

---

## UI Components

### Page Structure

```
┌─────────────────────────────────────────┐
│  Header (from layout)                   │
├──────────┬──────────────────────────────┤
│          │  Entity Navigation          │
│ Past     │  (Organizations/Projects/   │
│ Archive  │   Tech Stack/Topics)        │
│ Sidebar  ├──────────────────────────────┤
│          │  Section Header              │
│          │  (Trending {Entity})        │
│          ├──────────────────────────────┤
│          │  Time Range Selector         │
│          │  (Daily/Weekly/Monthly/     │
│          │   Yearly)                    │
│          ├──────────────────────────────┤
│          │  Snapshot Info               │
│          │  (Last updated: ...)        │
│          ├──────────────────────────────┤
│          │  Trending Items Grid/List    │
│          │  (Cards with rank, change)  │
└──────────┴──────────────────────────────┘
│  Footer (from layout)                   │
└─────────────────────────────────────────┘
```

### Key Components

**Entity Navigation:**
- Primary category selector above heading
- Teal highlighting for active entity
- Preserves current range and archive params

**Time Range Selector:**
- Four buttons: Daily, Weekly, Monthly, Yearly
- Teal highlighting for active range
- Updates URL query params

**Trending Items Display:**

**Organizations:**
- Grid layout (1/2/3 columns responsive)
- Card format with:
  - Logo or initial letter
  - Organization name
  - Rank badge (teal circle)
  - Change indicator (green/red with percentage)

**Other Entities (Projects/Tech Stack/Topics):**
- List layout
- Row format with:
  - Rank badge
  - Name
  - Current/Previous values
  - Change indicator

### Styling

- **Teal Theme**: `bg-teal-600`, `text-teal-600` for active states
- **Change Colors**: 
  - Green: Positive change (`text-green-700`, `bg-green-50`)
  - Red: Negative change (`text-red-700`, `bg-red-50`)
- **Dark Mode**: Full support with semantic color tokens

---

## Caching & Performance

### Static Generation

- **Route**: `/trending/:entity`
- **Revalidation**: `export const revalidate = 3600` (1 hour ISR)
- **Static Params**: All 4 entities pre-generated at build time

### Data Loading

- **Server-Side**: `loadTrendingSnapshot()` uses `fs.readFileSync`
- **No Database Queries**: All data from static JSON files
- **No API Calls**: Zero runtime data fetching

### ISR + Deployment Behavior

**Important**: How ISR works with file-based snapshots:

1. **GitHub Actions** generates new snapshot files and commits them to the repository
2. **Vercel** detects the commit and triggers a new deployment
3. **Build Process** includes the new JSON files in the build output
4. **ISR** serves pages from the new build, which includes the updated snapshot files

**Key Point**: ISR does not read from a mutable filesystem. Instead, it serves from the build output that was created when the commit was deployed. This ensures:
- Files are immutable at runtime
- No filesystem access needed in production
- CDN-friendly static assets
- Consistent behavior across all environments

### Performance Characteristics

- **Page Load**: < 100ms (file read + JSON parse)
- **Build Time**: Minimal (only 4 static params)
- **CDN-Friendly**: All pages are static, fully cacheable
- **Zero Server Load**: No per-request computation

### Cache Strategy

1. **Build Time**: Generate static pages for all entities
2. **ISR**: Revalidate every hour (checks for new snapshot files)
3. **Archive Pages**: Generated on-demand (first request)
4. **CDN**: All pages cached at edge

---

## GitHub Actions Workflow

### Workflow File

**Location**: `.github/workflows/generate-trending.yml`

### Schedule

```yaml
on:
  schedule:
    - cron: "0 0 * * *"  # Daily at 00:00 UTC
  workflow_dispatch:     # Manual trigger
```

### Steps

1. **Checkout**: Get latest code
2. **Setup Node.js**: Version 20 with npm cache
3. **Install pnpm**: Version 9
4. **Install Dependencies**: `pnpm install`
5. **Generate Prisma Client**: `pnpm prisma generate`
6. **Generate Trending Data**: `pnpm run generate:trending`
   - Requires `DATABASE_URL` secret
7. **Commit Changes**: 
   - Commits updated JSON files
   - Message: `chore: update trending snapshots [skip ci]`
   - Pushes to repository

### Permissions

```yaml
permissions:
  contents: write  # Required to commit files
```

### Error Handling

- Script failures cause workflow to exit with error
- No partial commits (atomic file writes prevent corruption)
- `[skip ci]` prevents infinite commit loops

---

## File Structure

### Key Files

```
app/trending/
├── [entity]/
│   ├── page.tsx                    # Server component (route handler)
│   ├── trending-page-client.tsx    # Client component (UI)
│   └── layout.tsx                  # Layout wrapper (header/footer)

lib/
└── trending-types.ts               # Types, loaders, validators

scripts/
└── generate-trending-data.ts       # Generation script

.github/workflows/
└── generate-trending.yml           # GitHub Actions workflow

new-api-details/trending/
└── [entity]/
    ├── {range}.json               # Latest snapshots
    └── {range}/                   # Archive directories
        └── YYYY-MM.json           # Archive files
```

### Dependencies

**package.json scripts:**
```json
{
  "scripts": {
    "generate:trending": "tsx scripts/generate-trending-data.ts"
  },
  "devDependencies": {
    "tsx": "^4.x.x"  // For running TypeScript directly
  }
}
```

---

## Type Definitions

### Core Types

**Location**: `lib/trending-types.ts`

```typescript
export type TrendingEntity = 'organizations' | 'projects' | 'tech-stack' | 'topics';
export type TrendingRange = 'daily' | 'weekly' | 'monthly' | 'yearly';

export interface TrendingSnapshot {
  entity: TrendingEntity;
  range: TrendingRange;
  published_at: string;
  snapshot_at: string;
  items: TrendingItem[];
  meta: {
    version: number;
    generated_at: string;
    total_items: number;
  };
}

export interface TrendingItem {
  id: string;
  slug: string;
  name: string;
  change: number;
  change_percent: number;
  current_value: number;
  previous_value: number;
  rank: number;
  metadata?: Record<string, unknown>;
}

// Entity-specific item types
export interface TrendingOrganizationItem extends TrendingItem {
  metadata: {
    img_r2_url?: string | null;
    logo_r2_url?: string | null;
    image_url?: string | null;
    total_projects?: number;
    category?: string;
  };
}

export interface ArchiveEntry {
  year: number;
  months?: number[];
  hasYearly?: boolean;
}
```

### Validation Functions

```typescript
export function isValidTrendingEntity(slug: string): slug is TrendingEntity;
export function isValidTrendingRange(range: string | null): range is TrendingRange;
```

### Loader Functions

```typescript
export async function loadTrendingSnapshot(
  entity: TrendingEntity,
  range?: TrendingRange,
  year?: number,
  month?: number
): Promise<TrendingSnapshot | null>;

export function getAvailableArchiveData(entity: TrendingEntity): ArchiveEntry[];
```

---

## Future Considerations

### Potential Enhancements

1. **Compare Mode**: Side-by-side comparison of two time periods
2. **Growth Charts**: Visual representation of trends over time
3. **"New Entry" Badges**: Highlight items that first appeared in trending
4. **"Biggest Mover" Labels**: Identify items with largest percentage changes
5. **Yearly Recap Pages**: Aggregate yearly trends with insights
6. **Export Functionality**: Download trending data as CSV/JSON
7. **Email Alerts**: Notify users when specific items enter trending

### Scalability

**Current Limits:**
- Top 100 items per snapshot (configured via `TOP_ITEMS_LIMIT` constant in `scripts/generate-trending-data.ts`)
- File-based storage (scales to thousands of files)
- No database queries (unlimited concurrent reads)

**Configuration Location:**
```typescript
// scripts/generate-trending-data.ts
const TOP_ITEMS_LIMIT = 100; // Maximum items per snapshot
```

**Future Scaling:**
- If files exceed 10,000+: Consider database-backed archive lookup
- If generation time > 5min: Parallelize entity processing
- If storage > 1GB: Consider compression or external storage

### Maintenance

**Regular Tasks:**
- Monitor GitHub Actions workflow success
- Review snapshot file sizes (should be < 100KB each)
- Check archive directory growth (cleanup old files if needed)
- Verify ranking stability (no excessive reordering)

**Troubleshooting:**
- If snapshots missing: Check GitHub Actions logs
- If archive not showing: Verify file naming (`YYYY-MM.json`)
- If ranking unstable: Check tie-breaker logic
- If generation fails: Verify `DATABASE_URL` secret

---

## Summary

The trending feature provides a scalable, performant solution for displaying time-based entity popularity:

✅ **Zero Runtime Cost**: All computation in generation, not page load  
✅ **Full History**: Complete archive of all snapshots  
✅ **SEO-Friendly**: Static pages with proper metadata  
✅ **User-Friendly**: Intuitive navigation and clear visual indicators  
✅ **Maintainable**: Automated generation, deterministic ranking  
✅ **Scalable**: File-based storage handles growth gracefully  

The architecture follows Next.js best practices, maintains consistency with existing codebase patterns, and provides a solid foundation for future enhancements.
